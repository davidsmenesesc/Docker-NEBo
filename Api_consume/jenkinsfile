
pipeline {

  environment {
    dockerimagebackend = "davidsmenesesc/cosa-loca"
    dockerBack= ""
  }

agent any

stages {
    stage('checkout'){
        steps{
            checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/davidsmenesesc/cosa-loca.git']])
        }
    }
    stage('Build image') {
      steps{
        script {
        sh 'ls'    
        dir('Api_consume') {
                dockerBack = docker.build dockerimagebackend
            }   
        }
      }
    }
    stage('Pushing Image') {
      environment {
               registryCredential = 'Dockerhub'
           }
      steps{
        script {
          docker.withRegistry( 'https://registry.hub.docker.com', registryCredential ) {
            sh 'env | sort'
            dockerBack.push('latest')
          }
        }
      }
    }
    stage('checkout'){
      steps{
          checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/davidsmenesesc/cosa-loca.git']])
      }
    }
    stage('Execute playbook'){
        steps{
            ansiblePlaybook credentialsId: 'JenkinsaAnsible', disableHostKeyChecking: true, installation: 'Ansible', inventory: '/home/yasufernando1_gmail_com/ansible/deploy.yaml', playbook: '/home/yasufernando1_gmail_com/ansible/deploy.yaml'
        }
    }
 }
}